"use strict";Object.defineProperty(exports,"e",{value:!0}),exports.instrument=void 0;var o,l=require("path"),c=require("jscodeshift"),a=require("jscodeshift/src/Collection"),t=require("../../scripts/FileOperationHelper"),i=require("../../scripts/PathsConstants"),r=require("./parser/Babel"),u=require("./model/Types");!function(e){e[e.n=-1]="Filtered",e[e.r=0]="Normal",e[e.t=1]="ReactNative",e[e.i=2]="React"}(o=o||{});var f=[];f.push({a:{c:"react-native",u:"TouchableHighlight"},o:{c:"@dynatrace/react-native-plugin/lib/react-native/",u:"TouchableHighlight",l:"@dynatrace/react-native-plugin/lib/react-native"}}),f.push({a:{c:"react-native",u:"TouchableOpacity"},o:{c:"@dynatrace/react-native-plugin/lib/react-native/",u:"TouchableOpacity",l:"@dynatrace/react-native-plugin/lib/react-native"}}),f.push({a:{c:"react-native",u:"TouchableNativeFeedback"},o:{c:"@dynatrace/react-native-plugin/lib/react-native/",u:"TouchableNativeFeedback",l:"@dynatrace/react-native-plugin/lib/react-native"}}),f.push({a:{c:"react-native",u:"TouchableWithoutFeedback"},o:{c:"@dynatrace/react-native-plugin/lib/react-native/",u:"TouchableWithoutFeedback",l:"@dynatrace/react-native-plugin/lib/react-native"}}),f.push({a:{c:"react-native",u:"Button"},o:{c:"@dynatrace/react-native-plugin/lib/react-native/",u:"Button",l:"@dynatrace/react-native-plugin/lib/react-native"}}),f.push({a:{c:"react-native",u:"RefreshControl"},o:{c:"@dynatrace/react-native-plugin/lib/react-native/",u:"RefreshControl",l:"@dynatrace/react-native-plugin/lib/react-native"}}),f.push({a:{c:"react-native",u:"Text"},o:{c:"@dynatrace/react-native-plugin/lib/react-native/",u:"Text",l:"@dynatrace/react-native-plugin/lib/react-native"}}),f.push({a:{c:"react-native",u:"Pressable"},o:{c:"@dynatrace/react-native-plugin/lib/react-native/",u:"Pressable",l:"@dynatrace/react-native-plugin/lib/react-native"}}),f.push({a:{c:"@react-native-picker/picker",u:"Picker"},o:{c:"@dynatrace/react-native-plugin/lib/community/Picker",u:"Picker",l:"@dynatrace/react-native-plugin/lib/community/Picker"}}),f.push({a:{c:"@react-native-picker/picker",u:"PickerIOS"},o:{c:"@dynatrace/react-native-plugin/lib/community/Picker",u:"PickerIOS",l:"@dynatrace/react-native-plugin/lib/community/Picker"}});var d=["AppRegistry","renderApplication"],instrument=function(e,n,r){n=b(n);var t,i=N(n);if(i!==o.n){var a=!1,c=y(n,e);if(i===o.i)A(c),a=!0;else if(i===o.t)n.endsWith("AppRegistry.js")?void 0!==r&&r.autoStart&&(I(c),a=!0):n.endsWith("renderApplication.js")&&(v(c),a=!0);else{var u=k(n,r);if(!u.input&&!u.lifecycle)return null!=r&&r.debug&&console.log("Dynatrace - Filtered All: ".concat(n)),g(n),e;u.lifecycle&&v(c)&&(a=!0),u.input&&f.forEach(function(e){var n=j(c,e);c=n.f,a=a||n.d})}a?(e=c.toSource({v:"single"}),h(e,n)):g(n),null!=r&&r.debug&&a&&console.log("Dynatrace - Modified Filename: "+n)}else{n.includes(l.join("@dynatrace","react-native-plugin"))&&n.endsWith(l.join("lib","instrumentor","base","configuration","ConfigurationDefaults.js"))&&void 0!==r&&(t=y(n,e),void 0!==r.debug&&s(t,"debugAuto",r.debug),void 0!==r.lifecycle&&s(t,"lifecycleUpdateAuto",r.lifecycle.includeUpdate),void 0!==r.input&&s(t,"actionNamePrivacyAuto",r.input.actionNamePrivacy),e=t.toSource({v:"single"}),h(e,n))}return e};exports.instrument=instrument;var v=function(e){var n=e.findJSXElements(),i=!1;return 0<n.length&&(e.find(c.FunctionDeclaration).forEach(function(e){var n,r,t=(0,a.fromPaths)([e]);0<t.findJSXElements().length&&null!=e&&null!=e.value&&null!=e.value.id&&e.value.id.name&&(n=t.find(c.ClassDeclaration),r=t.find(c.p),0===n.length&&0===r.length&&(p(e,u.Types.FunctionalComponent,e.value.id.name),i=!0))}),e.find(c.ClassDeclaration).forEach(function(e){0<(0,a.fromPaths)([e]).findJSXElements().length&&null!=e&&null!=e.value&&e.value.id&&e.value.id.name&&(p(e,u.Types.ClassComponent,e.value.id.name),i=!0)}),e.find(c.ArrowFunctionExpression).forEach(function(e){0<(0,a.fromPaths)([e]).findJSXElements().length&&null!=e.parent&&null!=e.parent.value&&null!=e.parent.value.id&&null!=e.parent.value.id.name&&(p(e,u.Types.FunctionalComponent,e.parent.value.id.name),i=!0)})),i},p=function(e,n,r){for(var t=c.expressionStatement(c.assignmentExpression("=",c.memberExpression(c.identifier(r),c.identifier("_dtInfo")),m(n,r)));void 0!==e.parentPath&&"body"!==e.parentPath.name;)e=e.parentPath;void 0!==e.parentPath&&e.insertAfter(t)},m=function(e,n){return c.objectExpression([c.objectProperty(c.identifier("type"),c.numericLiteral(e)),c.objectProperty(c.identifier("name"),c.stringLiteral(n))])},s=function(e,n,r){var t,i=e.find(c.Identifier).filter(function(e){return e.node.name===n&&"VariableDeclarator"===e.parent.value.type});1===i.length&&("NumericLiteral"===(t=i.paths()[0].parent.value).init.type&&"number"==typeof r?t.init=c.numericLiteral(r):"StringLiteral"===t.init.type&&"string"==typeof r?t.init=c.stringLiteral(r):"BooleanLiteral"===t.init.type&&"boolean"==typeof r&&(t.init=c.booleanLiteral(r)))},y=function(e,n){return c.withParser((0,r.babelParser)(l.extname(e)))(n)},b=function(e){return l.isAbsolute(e)?e.replace(i.default.m()+l.sep,""):e},g=function(e){try{var n=l.join(i.default.getBuildPath(),e+".dtx");t.default.checkIfFileExistsSync(n),t.default.deleteFileSync(n)}catch(e){}},h=function(e,n){var r=l.join(i.default.getBuildPath(),n);try{t.default.checkIfFileExistsSync(l.dirname(r))}catch(e){t.default.createDirectorySync(l.dirname(r))}t.default.writeTextToFileSync(r+".dtx",e)},k=function(e,n){var r={input:!1,lifecycle:!1};return void 0!==n&&(void 0!==n.lifecycle&&void 0!==n.lifecycle.instrument&&n.lifecycle.instrument(e)&&(r.lifecycle=!0),void 0!==n.input&&void 0!==n.input.instrument&&n.input.instrument(e)&&(r.input=!0)),r},A=function(e){var n,r=e.find(c.Program);1===r.length&&(n=c.expressionStatement(c.callExpression(c.memberExpression(c.callExpression(c.identifier("require"),[c.stringLiteral("@dynatrace/react-native-plugin/lib/instrumentor/base/ElementHelper")]),c.identifier("instrumentCreateElement")),[c.memberExpression(c.identifier("module"),c.identifier("exports"))])),r.paths()[0].node.body.push(n))},I=function(e){var n=w(e,"runApplication",!0);1===n.length&&(M(e,{s:"_DynatraceApplicationHandler",c:"@dynatrace/react-native-plugin",u:"ApplicationHandler"}),q(n.paths()[0].parent.value.body.body,0,W("_DynatraceApplicationHandler","startup")))},q=function(e,n){for(var r=arguments.length,t=new Array(2<r?r-2:0),i=2;i<r;i++)t[i-2]=arguments[i];return e.splice.apply(e,[n,0].concat(t))},w=function(e,n,t){for(var r=arguments.length,i=new Array(3<r?r-3:0),a=3;a<r;a++)i[a-3]=arguments[a];return e.find(c.Identifier).filter(function(e){return e.node.name===n}).filter(function(e){var n=void 0!==e.parent&&void 0!==e.parent.value;t||(n=n&&void 0!==e.parent.value.params&&e.parent.value.params.length===i.length);for(var r=0;r<0;r++)n=n&&e.parent.value.params[r].name===i[r];return n})},N=function(e){if(e.includes("@dynatrace"))return o.n;var n=l.extname(e);if(".js"!==n&&".ts"!==n&&".tsx"!==n&&".jsx"!==n)return o.n;for(var r=l.parse(e),t=r.dir.split(l.sep),i=0;i<t.length;i++)if("node_modules"===t[i]){if("react-native"===t[i+1]||"create-react-class"===t[i+1]||"react-clone-referenced-element"===t[i+1])return d.includes(r.name)?o.t:o.n;if("react"===t[i+1]&&"index"===r.name)return o.i}return o.r},P=function(e,n,r){var t=x(e,n,r);return T(e,n,r)||t},x=function(e,n,r){var t=F(e,n);if(0<t.length){var i=R(t,n.u,!1);return void 0!==i&&(r.s=i.localName),E(e,r),!0}return!1},T=function(e,n,r){var t=D(e,n.c);if(1===t.length){var i=R(t,n.u,!0);if(void 0!==i)return J(e,r.l,i.localName,"ImportNamespaceSpecifier"===i.type),!0}return!1},j=function(e,n){var r=JSON.parse(JSON.stringify(n.o));return{f:e,d:P(e,n.a,r)||H(e,n.a,n.o.l)}},F=function(e,n){return e.find(c.ImportDeclaration).filter(function(e){return e.node.source.value===n.c&&e.node.specifiers.some(function(e){return O(e)&&e.imported.name===n.u||e.local&&e.local.name===n.u})})},O=function(e){return void 0!==e.imported},H=function(e,n,r){var t=!1;return e.find(c.CallExpression).filter(function(e){return S(e.node.callee)&&C(e.node.arguments[0])&&e.node.arguments[0].value===n.c&&void 0!==e.parent}).forEach(function(e){(void 0===e.parent.value.property||void 0!==e.parent.value.property&&void 0!==e.parent.value.property.name&&e.parent.value.property.name===n.u)&&(e.node.arguments[0].value=r,t=t||!0)}),t},S=function(e){return"require"===e.name},C=function(e){return"StringLiteral"===e.type||"Literal"===e.type},D=function(e,n){return e.find(c.ImportDeclaration).filter(function(e){return e.node.source.value===n})},R=function(e,r,t){var i;return e.forEach(function(e){void 0!==e.node.specifiers&&(e.node.specifiers=e.node.specifiers.filter(function(e){if(!O(e)||t)return!(!O(e)&&t)||(null!==e.local&&(i={localName:e.local.name,type:e.type}),!1);var n=e.imported.name!==r;return n||null===e.local||e.imported.name===e.local.name||(i={localName:e.local.name,type:e.type}),n}),0===e.node.specifiers.length&&e.prune())}),i},_=function(e,n){e.find(c.ImportDeclaration).filter(function(e){return e.node.source.value===n.c}).forEach(function(e){e.node.specifiers.push(X(n))})},L=function(e,n,r){e.find(c.ImportDeclaration).filter(function(e){return e.node.source.value===n}).forEach(function(e){e.node.specifiers.push(r)})},B=function(e,n,r){var t,i=e.find(c.ImportDeclaration);0<i.length?c(i.paths()[0]).insertAfter(Q(n,r)):1===(t=e.find(c.Program)).length&&t.paths()[0].node.body.unshift(Q(n,r))},E=function(e,n){0<D(e,n.c).length?_(e,n):B(e,n.c,[X(n)])},J=function(e,n,r,t){var i=D(e,n),a=(t?Z:Y)(r);0<i.length?L(e,n,a):B(e,n,[a])},M=function(e,n){var r=e.find(c.VariableDeclaration);0<r.length&&c(r.paths()[0]).insertAfter(V(n))},W=function(e,n){return c.expressionStatement(U(e,n,[]))},U=function(e,n,r){return c.callExpression(G(e,n),r)},V=function(e){return c.variableDeclaration("var",[n(e)])},n=function(e){return c.variableDeclarator(void 0!==e.s?c.identifier(e.s):c.identifier(e.u),z(e))},z=function(e){return c.memberExpression(K(e),c.identifier(e.u))},G=function(e,n){return c.memberExpression(c.identifier(e),c.identifier(n))},K=function(e){return c.callExpression(c.identifier("require"),[c.literal(e.c)])},Q=function(e,n){return c.importDeclaration(n,c.literal(e))},X=function(e){return void 0!==e.s?c.importSpecifier(c.identifier(e.u),c.identifier(e.s)):c.importSpecifier(c.identifier(e.u))},Y=function(e){return c.importDefaultSpecifier(c.identifier(e))},Z=function(e){return c.importNamespaceSpecifier(c.identifier(e))};