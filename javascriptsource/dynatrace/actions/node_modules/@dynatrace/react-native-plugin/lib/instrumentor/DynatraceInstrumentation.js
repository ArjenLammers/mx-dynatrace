"use strict";var n=require("@babel/runtime/helpers/interopRequireDefault"),r=n(require("@babel/runtime/helpers/toConsumableArray"));Object.defineProperty(exports,"n",{value:!0}),exports.instrument=void 0;var c,f=require("path"),o=require("jscodeshift"),u=require("jscodeshift/src/Collection"),t=require("../../scripts/FileOperationHelper"),i=require("../../scripts/PathsConstants"),e=require("../react-native/Touchables.InstrInfo"),a=require("../react-native/RefreshControl.InstrInfo"),l=require("../community/gesture-handler/Touchables.InstrInfo"),v=require("../community/Picker.InstrInfo"),s=require("./parser/Babel"),d=require("./model/Types");!function(n){n[n.r=-1]="Filtered",n[n.e=0]="Normal",n[n.t=1]="ReactNative",n[n.i=2]="React"}(c=c||{});var p=[];p.push.apply(p,(0,r.default)(e.instrumentationInfo)),p.push.apply(p,(0,r.default)(a.instrumentationInfo)),p.push.apply(p,(0,r.default)(l.instrumentationInfo)),p.push.apply(p,(0,r.default)(v.instrumentationInfo));var m=["AppRegistry","renderApplication"],instrument=function(n,r,e){r=h(r);var t,i=_(r);if(i!==c.r){var u=!1,o=g(r,n);if(i===c.i)j(o),u=!0;else if(i===c.t)r.endsWith("AppRegistry.js")?void 0!==e&&e.autoStart&&(D(o),u=!0):r.endsWith("renderApplication.js")&&(y(o),u=!0);else{var a=x(r,e);if(!a.input&&!a.lifecycle)return null!=e&&e.debug&&console.log("Dynatrace - Filtered All: ".concat(r)),N(r),n;a.lifecycle&&y(o)&&(u=!0),a.input&&p.forEach(function(n){var r=F(o,n);o=r.u,u=u||r.o})}u?(n=o.toSource({a:"single"}),I(n,r)):N(r),null!=e&&e.debug&&u&&console.log("Dynatrace - Modified Filename: "+r)}else{r.includes(f.join("@dynatrace","react-native-plugin"))&&r.endsWith(f.join("lib","instrumentor","base","configuration","ConfigurationDefaults.js"))&&void 0!==e&&(t=g(r,n),void 0!==e.debug&&A(t,"debugAuto",e.debug),void 0!==e.lifecycle&&A(t,"lifecycleUpdateAuto",e.lifecycle.includeUpdate),void 0!==e.c&&A(t,"bundleNameAuto",e.c),void 0!==e.input&&A(t,"actionNamePrivacyAuto",e.input.actionNamePrivacy),n=t.toSource({a:"single"}),I(n,r))}return n};exports.instrument=instrument;var y=function(n){var r=n.findJSXElements(),i=!1;return 0<r.length&&(n.find(o.FunctionDeclaration).forEach(function(n){var r,e,t=(0,u.fromPaths)([n]);0<t.findJSXElements().length&&null!=n&&null!=n.value&&null!=n.value.id&&n.value.id.name&&(r=t.find(o.ClassDeclaration),e=t.find(o.f),0===r.length&&0===e.length&&(b(n,d.Types.FunctionalComponent,n.value.id.name),i=!0))}),n.find(o.ClassDeclaration).forEach(function(n){0<(0,u.fromPaths)([n]).findJSXElements().length&&null!=n&&null!=n.value&&n.value.id&&n.value.id.name&&(b(n,d.Types.ClassComponent,n.value.id.name),i=!0)}),n.find(o.ArrowFunctionExpression).forEach(function(n){0<(0,u.fromPaths)([n]).findJSXElements().length&&null!=n.parent&&null!=n.parent.value&&null!=n.parent.value.id&&null!=n.parent.value.id.name&&(b(n,d.Types.FunctionalComponent,n.parent.value.id.name),i=!0)})),i},b=function(n,r,e){for(var t=o.expressionStatement(o.assignmentExpression("=",o.memberExpression(o.identifier(e),o.identifier("_dtInfo")),q(r,e)));void 0!==n.parentPath&&"body"!==n.parentPath.name;)n=n.parentPath;void 0!==n.parentPath&&n.insertAfter(t)},q=function(n,r){return o.objectExpression([o.objectProperty(o.identifier("type"),o.numericLiteral(n)),o.objectProperty(o.identifier("name"),o.stringLiteral(r))])},A=function(n,r,e){var t,i=n.find(o.Identifier).filter(function(n){return n.node.name===r&&"VariableDeclarator"===n.parent.value.type});1===i.length&&("NumericLiteral"===(t=i.paths()[0].parent.value).init.type&&"number"==typeof e?t.init=o.numericLiteral(e):"StringLiteral"===t.init.type&&"string"==typeof e?t.init=o.stringLiteral(e):"BooleanLiteral"===t.init.type&&"boolean"==typeof e&&(t.init=o.booleanLiteral(e)))},g=function(n,r){return o.withParser((0,s.babelParser)(f.extname(n)))(r)},h=function(n){return f.isAbsolute(n)?n.replace(i.default.l()+f.sep,""):n},N=function(n){try{var r=f.join(i.default.getBuildPath(),n+".dtx");t.default.checkIfFileExistsSync(r),t.default.deleteFileSync(r)}catch(n){}},I=function(n,r){var e=f.join(i.default.getBuildPath(),r);try{t.default.checkIfFileExistsSync(f.dirname(e))}catch(n){t.default.createDirectorySync(f.dirname(e))}t.default.writeTextToFileSync(e+".dtx",n)},x=function(n,r){var e={input:!1,lifecycle:!1};return void 0!==r&&(void 0!==r.lifecycle&&void 0!==r.lifecycle.instrument&&r.lifecycle.instrument(n)&&(e.lifecycle=!0),void 0!==r.input&&void 0!==r.input.instrument&&r.input.instrument(n)&&(e.input=!0)),e},j=function(n){var r,e=n.find(o.Program);1===e.length&&(r=o.expressionStatement(o.callExpression(o.memberExpression(o.callExpression(o.identifier("require"),[o.stringLiteral("@dynatrace/react-native-plugin/lib/instrumentor/base/ElementHelper")]),o.identifier("instrumentCreateElement")),[o.memberExpression(o.identifier("module"),o.identifier("exports"))])),e.paths()[0].node.body.push(r))},D=function(n){var r=R(n,"runApplication",!0);1===r.length&&(G(n,{v:"_DynatraceApplicationHandler",module:"@dynatrace/react-native-plugin",reference:"ApplicationHandler"}),C(r.paths()[0].parent.value.body.body,0,K("_DynatraceApplicationHandler","startup")))},C=function(n,r){for(var e=arguments.length,t=new Array(2<e?e-2:0),i=2;i<e;i++)t[i-2]=arguments[i];return n.splice.apply(n,[r,0].concat(t))},R=function(n,r,t){for(var e=arguments.length,i=new Array(3<e?e-3:0),u=3;u<e;u++)i[u-3]=arguments[u];return n.find(o.Identifier).filter(function(n){return n.node.name===r}).filter(function(n){var r=void 0!==n.parent&&void 0!==n.parent.value;t||(r=r&&void 0!==n.parent.value.params&&n.parent.value.params.length===i.length);for(var e=0;e<0;e++)r=r&&n.parent.value.params[e].name===i[e];return r})},_=function(n){if(n.includes("@dynatrace"))return c.r;var r=f.extname(n);if(".js"!==r&&".ts"!==r&&".tsx"!==r&&".jsx"!==r)return c.r;for(var e=f.parse(n),t=e.dir.split(f.sep),i=0;i<t.length;i++)if("node_modules"===t[i]){if("react-native"===t[i+1]||"create-react-class"===t[i+1]||"react-clone-referenced-element"===t[i+1])return m.includes(e.name)?c.t:c.r;if("react"===t[i+1]&&"index"===e.name)return c.i}return c.e},H=function(n,r,e){var t=L(n,r,e);return S(n,r,e)||t},L=function(n,r,e){var t=O(n,r);if(0<t.length){var i=J(t,r.reference,!1);return void 0!==i&&(e.v=i.localName),V(n,e),!0}return!1},S=function(n,r,e){var t=E(n,r.module);if(1===t.length){var i=J(t,r.reference,!0);if(void 0!==i)return z(n,e.defaultImport,i.localName,"ImportNamespaceSpecifier"===i.type),!0}return!1},F=function(n,r){var e=JSON.parse(JSON.stringify(r.new));return{u:n,o:H(n,r.old,e)||T(n,r.old,r.new.defaultImport)}},O=function(n,r){return n.find(o.ImportDeclaration).filter(function(n){return n.node.source.value===r.module&&n.node.specifiers.some(function(n){return P(n)&&n.imported.name===r.reference||n.local&&n.local.name===r.reference})})},P=function(n){return void 0!==n.imported},T=function(n,r,e){var t=!1;return n.find(o.CallExpression).filter(function(n){return w(n.node.callee)&&B(n.node.arguments[0])&&n.node.arguments[0].value===r.module&&void 0!==n.parent}).forEach(function(n){(void 0===n.parent.value.property||void 0!==n.parent.value.property&&void 0!==n.parent.value.property.name&&n.parent.value.property.name===r.reference)&&(n.node.arguments[0].value=e,t=t||!0)}),t},w=function(n){return"require"===n.name},B=function(n){return"StringLiteral"===n.type||"Literal"===n.type},E=function(n,r){return n.find(o.ImportDeclaration).filter(function(n){return n.node.source.value===r})},J=function(n,e,t){var i;return n.forEach(function(n){void 0!==n.node.specifiers&&(n.node.specifiers=n.node.specifiers.filter(function(n){if(!P(n)||t)return!(!P(n)&&t)||(null!==n.local&&(i={localName:n.local.name,type:n.type}),!1);var r=n.imported.name!==e;return r||null===n.local||n.imported.name===n.local.name||(i={localName:n.local.name,type:n.type}),r}),0===n.node.specifiers.length&&n.prune())}),i},M=function(n,r){n.find(o.ImportDeclaration).filter(function(n){return n.node.source.value===r.module}).forEach(function(n){n.node.specifiers.push(rn(r))})},k=function(n,r,e){n.find(o.ImportDeclaration).filter(function(n){return n.node.source.value===r}).forEach(function(n){n.node.specifiers.push(e)})},U=function(n,r,e){var t,i=n.find(o.ImportDeclaration);0<i.length?o(i.paths()[0]).insertAfter(nn(r,e)):1===(t=n.find(o.Program)).length&&t.paths()[0].node.body.unshift(nn(r,e))},V=function(n,r){0<E(n,r.module).length?M(n,r):U(n,r.module,[rn(r)])},z=function(n,r,e,t){var i=E(n,r),u=(t?tn:en)(e);0<i.length?k(n,r,u):U(n,r,[u])},G=function(n,r){var e=n.find(o.VariableDeclaration);0<e.length&&o(e.paths()[0]).insertAfter(W(r))},K=function(n,r){return o.expressionStatement(Q(n,r,[]))},Q=function(n,r,e){return o.callExpression(Z(n,r),e)},W=function(n){return o.variableDeclaration("var",[X(n)])},X=function(n){return o.variableDeclarator(void 0!==n.v?o.identifier(n.v):o.identifier(n.reference),Y(n))},Y=function(n){return o.memberExpression($(n),o.identifier(n.reference))},Z=function(n,r){return o.memberExpression(o.identifier(n),o.identifier(r))},$=function(n){return o.callExpression(o.identifier("require"),[o.literal(n.module)])},nn=function(n,r){return o.importDeclaration(r,o.literal(n))},rn=function(n){return void 0!==n.v?o.importSpecifier(o.identifier(n.reference),o.identifier(n.v)):o.importSpecifier(o.identifier(n.reference))},en=function(n){return o.importDefaultSpecifier(o.identifier(n))},tn=function(n){return o.importNamespaceSpecifier(o.identifier(n))};